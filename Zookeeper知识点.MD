#### 1、2PC 与 3PC 
> 在跨多个节点执行事务时，为了保证事务处理的ACID特性，引入`协调者`、`参与者`的角色概念，参与者则是执行事务的各个节点，协调者则是负责调度参与者行为，并最终决定这些参与者是否要把事务真正进行提交的节点

##### 2PC（两阶段提交）：将事务执行分成了`投票`、`执行`两个阶段执行

> + 在`投票阶段`,协调者向所有参与者发送事务内容，询问各个参与者是否可以执行该事务，之后开始等待各个参与者的响应。
> + 各个参与者接收到事务内容后执行事务操作，并将`Undo`和`Redo`信息记入事务日志，注意此时各个参与者只是执行了事务，但是并未`Commit`
> + 如果参与者成功的执行了事务内容，则反馈`Yes`给协调者，表示可以执行事务；如果参与者没有成功执行事务内容，则反馈`No`给协调者表示事务不可执行；如果协调者在等待参与者响应时，等待超时，则认为该参与者反馈的结果是`No`。

> + 在`执行`阶段，协调者如果从所有的参与者得到的反馈结果都是`Yes`，则向所有的参与者发送`Commit`请求;如果任何一个参与者向协调者反馈了`No`，则向所有的参与者发送`Rollback`请求
> + 参与者在接收到协调者的信号（`Yes`、`Rollback`）后，如果是`Yes`，则提交事务，并在提交完成之后释放整个事务执行期间的所有事务资源；如果是`No`，则利用投票阶段中记录的`Undo`信息来执行回滚操作，回滚完成之后释放整个事务执行期间的所有事务资源。
> + 参与者在提交/回滚事务完成之后，向协调者发送`ACK`消息
> + 协调者接收到所有参与者的`ACK`消息之后，结束本次事务请求

##### 2PC的缺点
> + **同步阻塞**：在提交阶段，各个参与者都在等待其他参与者的事务执行反馈结果的过程中，无法进行其他任何操作，会一直处于同步阻塞状态

> + **单点问题**：提交阶段过渡依赖于协调节点，如果协调节点在进入提交阶段后挂掉，那么参与者将会一直处于锁定事务资源的状态，无法继续完成事务操作

> + **数据不一致**：在提交阶段，当协调向所有参与者发送`Commit`请求后，发生了网络分区，或者尚未发送完`Commit`请求之前协调者就挂掉了，导致部分参与者未能接收到请求，部分参与者接收到了请求，这样子会出现数据不一致现象发生。

##### 3PC（三阶段提交）：将事务执行分成了`CanCommit`、`PreCommit`、`DoCommit`三个阶段执行
> + 在`CanCommit`阶段，协调者向所有参与者发送一条包含事务内容的`CanCommit`请求，询问是否可以执行事务内容，并等待各个参与者的响应
> + 参与者接收到`CanCommit`请求后，根据自身情况反馈是否可以顺利执行事务内容，如果可以执行，则返回`Yes`，如果不可以执行，则返回`No`

> + 在`PreCommit`阶段 ，如果协调者接受到的所有参与者的反馈结果都是`Yes`，则向所有参与者节点发出`PreCommit`请求；如果任何一个参与者的反馈结果是`No`，则协调者向所有参与者节点发出`Abort`请求；如果协调者在等待参与者响应时，等待超时，则认为该参与者反馈的结果是`No`。
> + 参与者在接收到协调者请求后，如果是`PreCommit`，则执行事务内容，并将`Undo`、`Redo`信息记录到事务日志，最后根据执行结果`Yes`或`No`，反馈给协调者（注意此时事务并未执行`Commit`操作）；如果是`Abort`，或者在等待协调者请求时等待超过，则中断事务。

> + 在`DoCommit`阶段，如果`PreCommit`阶段，协调者向参与发出的请求时`Abort`，则不存在本阶段。
> + 如果协调者接受所有的参与者执行事务内容的反馈结果都是`Yes`,则发送`DoCommit`请求给所有参与者；如果任何一个参与者的事务内容执行的反馈结果是`No`，则协调者向所有参与者发送`Abort`请求；如果协调者在等待参与者响应时，等待超时，则认为该参与者事务内容执行的反馈结果是`No`
> + 参与者在接收到协调者请求（`DoCommit`或者`Abort`）后，如果是`DoCommit`，则执行事务提交，并在事务提交完成之后释放整个事务执行期间的所有事务资源；如果是`Abort`，则根据`PreCommit`阶段中的`Undo`信息来执行回滚操作，回滚完成之后释放整个事务执行期间的所有事务资源；**如果参与者在等待协调者请求时，等待超过，则继续执行事务提交。**

##### 3PC的优点
> + 降低了参与者的阻塞范围，利用`CanCommit`阶段，一定程度的降低了由于部分参与者执行事务失败带来的无效阻塞

> + 解决了单点问题，即使`DoCommit`阶段，协调者挂掉了，参与者也能执行事务提交，不会出现参与者一直处于锁定事务状态中的情况

##### 3PC的缺点
> + **数据不一致**：在`PreCommit`阶段，所有的参与者都接收到协调者的`PreCommit`请求后，出现网络分区。协调者由于网络分区接收不到部分参与者的事务内容执行反馈结果，故在`DoCommit`阶段向所有参与者发出的请求是`Abort`。然而这部分网络隔离的参与者由于无法与协调者通信，也意味着无法接受参与者在`DoCommit`阶段的请求。最后，因为在`DoCommit`阶段，参与者等待协调者请求超时后就会自行执行事务提交，必然导致数据不一致状态。

#### 2、PAXOS协议

#### 3、ZAB协议

#### 4、Zookeeper Leader选举过程

#### 5、Zookeeper数据存储

#### 6、Zookeeper如何实现Master选举

#### 7、Zookeeper如何实现分布式锁